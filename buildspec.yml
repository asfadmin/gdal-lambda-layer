# This build script is designed to run in AWS CodeBuild using the amazonlinux:2017.03.1.20170812 image from dockerhub

version: 0.1

env:
  variables:
    LAYER_NAME: gdal
    LAYER_DESCRIPTION: gdal 2.4.0 for python2.7 with netcdf/hdf5 support

phases:
  build:
    commands:
    - yum update -y
    - yum install -y gcc gcc-c++ python27-pip python27-devel libcurl-devel wget unzip diffutils file zip
    - yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
    - yum install -y netcdf-devel hdf5-devel
    - wget --no-verbose http://download.osgeo.org/gdal/2.4.0/gdal240.zip
    - unzip gdal240.zip
    - mkdir gdal-layer
    - mkdir gdal-layer/python
    - mkdir gdal-layer/lib
    - mkdir gdal-layer/lib/data
    - cd gdal-2.4.0 && ./configure >> ../gdal-layer/configure.txt
    - cd gdal-2.4.0 && make -j $(nproc)
    - cd gdal-2.4.0 && make install
    - cp /usr/local/lib/libgdal.so.20 gdal-layer/lib/
    - cp /usr/lib64/libnetcdf.so.7 gdal-layer/lib/
    - cp /usr/lib64/libhdf5.so.8 gdal-layer/lib/
    - cp /usr/lib64/libhdf5_hl.so.8 gdal-layer/lib/
    - cp /usr/lib64/libcurl.so.4 gdal-layer/lib/
    - cp /usr/lib64/libsz.so.2 gdal-layer/lib/
    - cp /usr/lib64/libaec.so.0 gdal-layer/lib/
    - strip gdal-layer/lib/*.so*
    - cp /usr/local/share/gdal/* gdal-layer/lib/data/
    - pip install numpy==1.16.0 gdal==2.4.0 -t gdal-layer/python
    - cd gdal-layer && zip -r ../gdal-layer.zip *
    - pip install awscli==1.16.94
    - aws lambda publish-layer-version --layer-name $LAYER_NAME --description $LAYER_DESCRIPTION --compatible-runtimes python2.7 --license-info MIT --zip-file fileb://gdal-layer.zip
